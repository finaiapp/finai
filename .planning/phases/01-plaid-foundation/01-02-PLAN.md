---
phase: 01-plaid-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - server/api/plaid/link-token.post.ts
  - server/api/plaid/exchange.post.ts
  - server/api/plaid/accounts.get.ts
  - app/plugins/plaid-link.client.ts
  - app/composables/usePlaidLink.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/plaid/link-token returns a fresh link_token for the authenticated user"
    - "POST /api/plaid/exchange accepts a public_token, encrypts the access_token, stores item + accounts"
    - "GET /api/plaid/accounts returns the user's linked accounts with institution info"
    - "usePlaidLink composable can fetch a link token and open Plaid Link"
  artifacts:
    - path: "server/api/plaid/link-token.post.ts"
      provides: "Link token creation endpoint"
      contains: "linkTokenCreate"
    - path: "server/api/plaid/exchange.post.ts"
      provides: "Public token exchange endpoint"
      contains: "itemPublicTokenExchange"
    - path: "server/api/plaid/accounts.get.ts"
      provides: "List linked accounts endpoint"
      contains: "getUserPlaidAccounts"
    - path: "app/composables/usePlaidLink.ts"
      provides: "Client-side Plaid Link wrapper"
      contains: "window.Plaid.create"
    - path: "app/plugins/plaid-link.client.ts"
      provides: "CDN script loader for Plaid Link JS"
      contains: "cdn.plaid.com"
  key_links:
    - from: "server/api/plaid/link-token.post.ts"
      to: "server/utils/plaid.ts"
      via: "plaidClient.linkTokenCreate"
      pattern: "plaidClient\\.linkTokenCreate"
    - from: "server/api/plaid/exchange.post.ts"
      to: "server/utils/encryption.ts"
      via: "encrypt(access_token)"
      pattern: "encrypt\\("
    - from: "server/api/plaid/exchange.post.ts"
      to: "server/utils/plaid-accounts.ts"
      via: "createPlaidItem + storePlaidAccounts"
      pattern: "createPlaidItem|storePlaidAccounts"
    - from: "app/composables/usePlaidLink.ts"
      to: "/api/plaid/link-token"
      via: "$fetch POST"
      pattern: "\\$fetch.*link-token"
    - from: "app/composables/usePlaidLink.ts"
      to: "/api/plaid/exchange"
      via: "$fetch POST on success"
      pattern: "\\$fetch.*exchange"
---

<objective>
Plaid Link integration: server API endpoints and client-side composable.

Purpose: Enable the full Plaid Link flow â€” create link tokens on-demand, handle the client-side bank connection UI, exchange public tokens for encrypted access tokens, and fetch linked account data.
Output: Three API endpoints (link-token, exchange, accounts), a client-side Plaid Link composable, and a CDN script loader plugin.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-plaid-foundation/01-RESEARCH.md
@.planning/phases/01-plaid-foundation/01-01-SUMMARY.md
@server/utils/plaid.ts
@server/utils/encryption.ts
@server/utils/plaid-accounts.ts
@server/database/schema.ts
@app/composables/useTransactions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plaid API endpoints (link-token, exchange, accounts)</name>
  <files>server/api/plaid/link-token.post.ts, server/api/plaid/exchange.post.ts, server/api/plaid/accounts.get.ts</files>
  <action>
Create `server/api/plaid/link-token.post.ts`:
- Require authenticated session via `requireUserSession(event)`
- Call `plaidClient.linkTokenCreate()` with:
  - user: { client_user_id: String(session.user.id) }
  - client_name: 'finai'
  - products: [Products.Transactions] (import Products from 'plaid')
  - country_codes: [CountryCode.Us] (import CountryCode from 'plaid')
  - language: 'en'
- Return `{ link_token: response.data.link_token }`
- Wrap in try/catch, use extractPlaidError for error responses
- Apply rate limiting with apiRateLimiter (existing pattern from server/middleware/)

Create `server/api/plaid/exchange.post.ts`:
- Require authenticated session
- Read body: `{ public_token: string, metadata: { institution?: { institution_id: string, name: string } } }`
- Validate public_token is a non-empty string, return 400 if missing
- Call `plaidClient.itemPublicTokenExchange({ public_token })`
- Encrypt access_token with `encrypt()` from server/utils/encryption.ts
- Call `createPlaidItem()` with userId, item_id, encrypted token, institution metadata from body
- Call `plaidClient.accountsGet({ access_token })` to fetch accounts (use the UNENCRYPTED token, not the encrypted one)
- Call `storePlaidAccounts()` with the Plaid accounts response
- Return `{ success: true, itemId: item_id }`
- Wrap in try/catch with extractPlaidError
- IMPORTANT: Do NOT log the access_token anywhere

Create `server/api/plaid/accounts.get.ts`:
- Require authenticated session
- Call `getUserPlaidAccounts(session.user.id)` from server/utils/plaid-accounts.ts
- Return the accounts array with institution info
- Include institution name and item status from the joined plaid_items data

Follow existing API patterns: use createError for HTTP errors, consistent error shape.
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. The endpoints should compile and be routable at /api/plaid/link-token, /api/plaid/exchange, /api/plaid/accounts.
  </verify>
  <done>Three API endpoints exist and compile. link-token creates on-demand tokens. exchange handles the full token swap + encrypted storage + account fetch. accounts returns user's linked accounts.</done>
</task>

<task type="auto">
  <name>Task 2: Plaid Link client plugin and composable</name>
  <files>app/plugins/plaid-link.client.ts, app/composables/usePlaidLink.ts</files>
  <action>
Create `app/plugins/plaid-link.client.ts`:
- Client-only Nuxt plugin (the `.client.ts` suffix ensures this)
- Load the Plaid Link JS from CDN: `https://cdn.plaid.com/link/v2/stable/link-initialize.js`
- Create a script element, set src and async=true, append to document.head
- Guard: only load if `window.Plaid` is not already defined
- Return a provide for `plaidLinkReady` as a Promise that resolves when the script's onload fires (so the composable can await it)

Create `app/composables/usePlaidLink.ts`:
- Declare global Window.Plaid type with create method (PlaidLinkConfig -> PlaidLinkHandler)
- Define TypeScript interfaces: PlaidLinkConfig (token, onSuccess, onExit, onEvent), PlaidLinkHandler (open, exit, destroy), PlaidLinkMetadata (institution with id+name, accounts, link_session_id), PlaidLinkError (error_type, error_code, error_message, display_message)
- Export `usePlaidLink()` composable returning: { openLink, loading, error, success }
- `openLink()` flow:
  1. Set loading=true, error=null, success=false
  2. POST to `/api/plaid/link-token` to get fresh link_token
  3. Await plaidLinkReady (from plugin) to ensure CDN script is loaded
  4. Call `window.Plaid.create()` with the token
  5. onSuccess callback: POST to `/api/plaid/exchange` with { public_token, metadata }, set success=true, set loading=false
  6. onExit callback: if err, set error to err.display_message or 'Connection cancelled'. Set loading=false
  7. Call handler.open() to show the Plaid Link UI
  8. On any catch: set error='Failed to initialize bank connection', loading=false
- Clean up handler on component unmount via onUnmounted -> handler.destroy()
- Follow existing composable patterns from useTransactions.ts (refs for state, try/catch, handleApiError for $fetch errors)
- Accept an optional `onSuccess` callback parameter so the calling component can refresh its account list after a successful connection
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. Check that the plugin is recognized by Nuxt (it should auto-register from the plugins/ directory).
  </verify>
  <done>Plaid Link CDN script loads on client. usePlaidLink composable provides openLink() that creates a fresh link token, opens Plaid Link, exchanges the public token on success, and reports loading/error/success state. Components can call openLink() and react to state changes.</done>
</task>

</tasks>

<verification>
- `bun run build` passes with no TypeScript errors
- API routes exist at /api/plaid/link-token (POST), /api/plaid/exchange (POST), /api/plaid/accounts (GET)
- Plugin file exists at app/plugins/plaid-link.client.ts
- Composable exports usePlaidLink with openLink, loading, error, success
</verification>

<success_criteria>
The complete Plaid Link flow is wired end-to-end: composable fetches a link token from the API, opens Plaid Link UI, receives the public token on success, exchanges it via the API (which encrypts and stores it), and fetches accounts. The accounts GET endpoint returns stored account data for UI display in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/01-plaid-foundation/01-02-SUMMARY.md`
</output>
