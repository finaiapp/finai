---
phase: 01-plaid-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - app/components/plaid/ConnectBank.vue
  - app/components/plaid/AccountsList.vue
  - app/pages/dashboard/accounts.vue
  - app/components/dashboard/Sidebar.vue
  - app/pages/dashboard/index.vue
autonomous: false

must_haves:
  truths:
    - "User can click Connect Bank and see the Plaid Link UI open"
    - "After connecting, linked accounts appear in a list with institution name, account name, type, and mask"
    - "Dashboard sidebar has an Accounts navigation item"
    - "Dashboard overview shows a Connected Accounts card with count"
  artifacts:
    - path: "app/components/plaid/ConnectBank.vue"
      provides: "Connect Bank button triggering Plaid Link"
      contains: "openLink"
    - path: "app/components/plaid/AccountsList.vue"
      provides: "List of connected bank accounts with institution info"
      contains: "plaid/accounts"
    - path: "app/pages/dashboard/accounts.vue"
      provides: "Accounts dashboard page"
      contains: "definePageMeta"
    - path: "app/components/dashboard/Sidebar.vue"
      provides: "Updated sidebar with Accounts nav item"
      contains: "accounts"
  key_links:
    - from: "app/components/plaid/ConnectBank.vue"
      to: "app/composables/usePlaidLink.ts"
      via: "usePlaidLink() composable"
      pattern: "usePlaidLink"
    - from: "app/components/plaid/AccountsList.vue"
      to: "/api/plaid/accounts"
      via: "$fetch GET"
      pattern: "\\$fetch.*plaid/accounts"
    - from: "app/pages/dashboard/accounts.vue"
      to: "app/components/plaid/ConnectBank.vue"
      via: "component usage"
      pattern: "PlaidConnectBank|ConnectBank"
---

<objective>
Connected accounts UI in the dashboard.

Purpose: Give the user a visible way to connect bank accounts and see their linked accounts. This completes the Phase 1 user story: "User can connect real bank accounts and see them listed in the dashboard."
Output: Accounts page with Connect Bank button and accounts list, updated sidebar navigation, and connected accounts indicator on dashboard overview.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-plaid-foundation/01-RESEARCH.md
@.planning/phases/01-plaid-foundation/01-01-SUMMARY.md
@.planning/phases/01-plaid-foundation/01-02-SUMMARY.md
@app/pages/dashboard/index.vue
@app/components/dashboard/Sidebar.vue
@app/composables/usePlaidLink.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plaid components and accounts page</name>
  <files>app/components/plaid/ConnectBank.vue, app/components/plaid/AccountsList.vue, app/pages/dashboard/accounts.vue</files>
  <action>
Create `app/components/plaid/ConnectBank.vue`:
- Uses the `usePlaidLink()` composable
- Renders a UButton with icon `i-lucide-landmark` and label "Connect Bank"
- Button click calls `openLink()`
- Shows loading state on button while Plaid Link is active (use :loading prop)
- Shows UAlert with error color if error ref has a value
- After successful connection (success ref), emit a 'connected' event so parent can refresh
- Pass an onSuccess callback to usePlaidLink that emits the 'connected' event

Create `app/components/plaid/AccountsList.vue`:
- Accepts no props (fetches its own data)
- On mount, fetches accounts from `GET /api/plaid/accounts` using $fetch
- Maintains refs: accounts (array), loading (boolean), error (string|null)
- Expose a `refresh()` method (via defineExpose) so parent can trigger refresh after connecting
- Display accounts grouped by institution:
  - Institution header: institution name (from plaid_items join)
  - Under each institution: list of accounts as UCard items showing:
    - Account name (bold) + official name (subtitle, if different)
    - Account type badge (checking/savings/credit) using UBadge with color based on type (green for checking, blue for savings, orange for credit)
    - Last 4 digits (mask) displayed as "****{mask}"
    - Balance if available (formatted with formatAmount)
  - Use Nuxt UI components: UCard for each institution group, flex layout for account rows
- Empty state: "No bank accounts connected yet. Click Connect Bank to get started." with an icon
- Loading state: spinning loader (match existing dashboard pattern with i-lucide-loader-2)
- Error state: UAlert with error color

Create `app/pages/dashboard/accounts.vue`:
- `definePageMeta({ layout: 'dashboard', middleware: 'auth' })`
- `useSeoMeta({ title: 'Accounts - finai' })`
- Page header: "Bank Accounts" (h1) with PlaidConnectBank component in the header row (flex justify-between)
- PlaidAccountsList component below the header
- Wire ConnectBank's @connected event to AccountsList's refresh() method via template ref
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. Verify the page is accessible at /dashboard/accounts.
  </verify>
  <done>Accounts page renders with Connect Bank button and accounts list. ConnectBank triggers Plaid Link. AccountsList displays linked accounts grouped by institution. The two components communicate via event/ref for refresh after connection.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard sidebar and overview integration</name>
  <files>app/components/dashboard/Sidebar.vue, app/pages/dashboard/index.vue</files>
  <action>
Update `app/components/dashboard/Sidebar.vue`:
- Add "Accounts" item to the navigation menu items array, positioned after "Overview" and before "Transactions"
- Icon: `i-lucide-landmark`
- Route: `/dashboard/accounts`

Update `app/pages/dashboard/index.vue`:
- Add a "Connected Accounts" overview card to the cards computed array
- Fetch account count from GET /api/plaid/accounts on mount (alongside existing fetchSummary and fetchTransactions)
- Card shows count of connected accounts (e.g., "3 accounts" or "None")
- Icon: `i-lucide-landmark`
- Replace the existing "Budget Status" card (which shows "No budgets" hardcoded) with the "Connected Accounts" card since budgets are not implemented yet
- Pattern: if accounts.length > 0, show "{N} accounts", else show "Not connected"
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. Verify sidebar shows Accounts link. Verify dashboard overview includes connected accounts card.
  </verify>
  <done>Dashboard sidebar has Accounts navigation item. Dashboard overview page shows connected account count. User has clear paths to the accounts page from both sidebar nav and overview card.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Plaid Link flow end-to-end</name>
  <action>Human verifies the complete Plaid Link flow works in Sandbox mode.</action>
  <what-built>Complete Plaid Link flow: database tables, encrypted token storage, API endpoints, Plaid Link UI, connected accounts display in dashboard</what-built>
  <how-to-verify>
1. Ensure Plaid env vars are set in .env (PLAID_CLIENT_ID, PLAID_SECRET, PLAID_ENV=sandbox, PLAID_TOKEN_ENCRYPTION_KEY)
2. Start dev server: `bun run dev`
3. Log in and navigate to /dashboard/accounts
4. Verify the page shows "Bank Accounts" heading with a "Connect Bank" button
5. Verify the accounts list shows empty state message
6. Click "Connect Bank" — Plaid Link UI should open
7. In Plaid Sandbox: select any institution, use credentials user_good / pass_good
8. Complete the flow — Plaid Link should close
9. Verify accounts now appear in the list with institution name, account type, mask
10. Navigate to /dashboard — verify sidebar has "Accounts" link and overview shows account count
11. Check database: `SELECT item_id, encrypted_access_token FROM plaid_items` — verify the token is NOT plaintext (should be base64:base64:base64 format)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `bun run build` passes with no TypeScript errors
- /dashboard/accounts page renders with Connect Bank button and accounts list
- Sidebar navigation includes Accounts link
- Dashboard overview includes connected accounts card
- Full Plaid Link flow works in Sandbox (connect -> accounts appear)
- Access tokens in database are encrypted (not plaintext)
</verification>

<success_criteria>
Phase 1 success criteria are met:
1. User can click "Connect Bank" and complete the Plaid Link flow
2. Linked bank accounts appear in the dashboard with institution name and account details
3. Access tokens are encrypted with AES-256-GCM before storage
4. Link tokens are created on-demand (not cached or pre-generated)
</success_criteria>

<output>
After completion, create `.planning/phases/01-plaid-foundation/01-03-SUMMARY.md`
</output>
