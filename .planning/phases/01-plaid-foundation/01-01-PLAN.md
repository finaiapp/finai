---
phase: 01-plaid-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/database/schema.ts
  - server/database/migrations/0002_plaid_tables.sql
  - server/utils/plaid.ts
  - server/utils/encryption.ts
  - server/utils/plaid-accounts.ts
  - .env.example
autonomous: true
user_setup:
  - service: plaid
    why: "Bank account connectivity via Plaid API"
    env_vars:
      - name: PLAID_CLIENT_ID
        source: "Plaid Dashboard (https://dashboard.plaid.com) -> Developers -> Keys"
      - name: PLAID_SECRET
        source: "Plaid Dashboard -> Developers -> Keys -> Sandbox secret"
      - name: PLAID_ENV
        source: "Set to 'sandbox' for development"
      - name: PLAID_TOKEN_ENCRYPTION_KEY
        source: "Generate with: node -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\""

must_haves:
  truths:
    - "Plaid tables exist in PostgreSQL and Drizzle can query them"
    - "Access tokens are encrypted before storage and decryptable after retrieval"
    - "Plaid SDK client is configured and can make API calls"
  artifacts:
    - path: "server/database/schema.ts"
      provides: "plaidItems, plaidAccounts, syncCursors table definitions"
      contains: "plaid_items"
    - path: "server/database/migrations/0002_plaid_tables.sql"
      provides: "Migration SQL for Plaid tables"
      contains: "CREATE TABLE"
    - path: "server/utils/encryption.ts"
      provides: "AES-256-GCM encrypt/decrypt functions"
      exports: ["encrypt", "decrypt"]
    - path: "server/utils/plaid.ts"
      provides: "Configured PlaidApi singleton"
      exports: ["plaidClient"]
    - path: "server/utils/plaid-accounts.ts"
      provides: "CRUD operations for plaid_items and plaid_accounts"
      exports: ["createPlaidItem", "getUserPlaidItems", "getUserPlaidAccounts", "storePlaidAccounts"]
  key_links:
    - from: "server/utils/plaid-accounts.ts"
      to: "server/database/schema.ts"
      via: "Drizzle schema imports"
      pattern: "import.*plaidItems.*from.*schema"
    - from: "server/utils/plaid-accounts.ts"
      to: "server/utils/encryption.ts"
      via: "encrypt/decrypt for access tokens"
      pattern: "import.*encrypt.*from.*encryption"
---

<objective>
Database schema and Plaid client setup for the Plaid Foundation phase.

Purpose: Establish the data layer and server utilities needed for all Plaid functionality. This is the foundation that Plans 02 and 03 build on.
Output: Three new DB tables (plaid_items, plaid_accounts, sync_cursors), Plaid SDK client singleton, AES-256-GCM encryption utilities, and CRUD operations for Plaid data.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-plaid-foundation/01-RESEARCH.md
@server/database/schema.ts
@server/utils/transactions.ts
@drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema and migration for Plaid tables</name>
  <files>server/database/schema.ts, server/database/migrations/0002_plaid_tables.sql</files>
  <action>
Install the plaid npm package:
```bash
bun add plaid
```

Add three new tables to `server/database/schema.ts`, following the existing pattern (serial IDs, timestamps, indexes, references with onDelete cascade):

1. `plaidItems` table (`plaid_items`):
   - id: serial primary key
   - userId: integer, NOT NULL, references users.id (onDelete cascade)
   - itemId: varchar(255), NOT NULL, unique (Plaid's item_id)
   - encryptedAccessToken: text, NOT NULL
   - institutionId: varchar(100), nullable
   - institutionName: varchar(255), nullable
   - status: varchar(50), NOT NULL, default 'healthy'
   - createdAt: timestamp, defaultNow, NOT NULL
   - updatedAt: timestamp, defaultNow, NOT NULL, $onUpdate
   - Index on userId

2. `plaidAccounts` table (`plaid_accounts`):
   - id: serial primary key
   - userId: integer, NOT NULL, references users.id (onDelete cascade)
   - plaidItemId: integer, NOT NULL, references plaidItems.id (onDelete cascade)
   - accountId: varchar(255), NOT NULL, unique (Plaid's account_id)
   - name: varchar(255), NOT NULL
   - officialName: varchar(255), nullable
   - mask: varchar(10), nullable (last 4 digits)
   - type: varchar(50), NOT NULL (checking, savings, credit, etc.)
   - subtype: varchar(50), nullable
   - currentBalance: numeric(12,2), nullable
   - availableBalance: numeric(12,2), nullable
   - isoCurrencyCode: varchar(10), nullable
   - createdAt: timestamp, defaultNow, NOT NULL
   - updatedAt: timestamp, defaultNow, NOT NULL, $onUpdate
   - Indexes on userId and plaidItemId

3. `syncCursors` table (`sync_cursors`):
   - id: serial primary key
   - plaidItemId: integer, NOT NULL, references plaidItems.id (onDelete cascade), unique
   - cursor: text, nullable
   - updatedAt: timestamp, defaultNow, NOT NULL, $onUpdate

Add Drizzle relations:
- users has many plaidItems
- plaidItems belongs to users, has many plaidAccounts, has one syncCursor
- plaidAccounts belongs to users and plaidItems

Generate migration:
```bash
bunx drizzle-kit generate
```

Run migration:
```bash
bunx drizzle-kit push
```

Update `.env.example` with the four new Plaid env vars (PLAID_CLIENT_ID, PLAID_SECRET, PLAID_ENV=sandbox, PLAID_TOKEN_ENCRYPTION_KEY).
  </action>
  <verify>
Run `bunx drizzle-kit push` successfully. Verify tables exist:
```bash
docker exec finai-postgres psql -U finai -d finai -c "\dt plaid_*"
docker exec finai-postgres psql -U finai -d finai -c "\dt sync_cursors"
```
Run `bun run build` to confirm no TypeScript errors in schema.
  </verify>
  <done>plaid_items, plaid_accounts, and sync_cursors tables exist in PostgreSQL. Schema file has all three table definitions with proper relations. Migration file generated.</done>
</task>

<task type="auto">
  <name>Task 2: Plaid client singleton, encryption utilities, and account CRUD</name>
  <files>server/utils/plaid.ts, server/utils/encryption.ts, server/utils/plaid-accounts.ts</files>
  <action>
Create `server/utils/encryption.ts`:
- Import createCipheriv, createDecipheriv, randomBytes from `node:crypto`
- Use AES-256-GCM algorithm
- Read encryption key from `process.env.PLAID_TOKEN_ENCRYPTION_KEY` as hex (32 bytes = 64 hex chars)
- `encrypt(plaintext: string): string` — generates random 12-byte IV, encrypts, returns `iv:authTag:ciphertext` (all base64-encoded, colon-separated)
- `decrypt(stored: string): string` — splits on colons, decodes base64, decrypts and returns plaintext
- Add validation: throw clear error if PLAID_TOKEN_ENCRYPTION_KEY is missing or wrong length

Create `server/utils/plaid.ts`:
- Import Configuration, PlaidApi, PlaidEnvironments from 'plaid'
- Create singleton PlaidApi instance configured from env vars:
  - basePath from PlaidEnvironments[PLAID_ENV] (default to 'sandbox')
  - Headers: PLAID-CLIENT-ID, PLAID-SECRET, Plaid-Version: '2020-09-14'
- Export as `plaidClient`
- Also export a helper `extractPlaidError(error: unknown): { statusCode: number; message: string }` that extracts display_message from Plaid's error.response.data structure, falling back to error_message then generic message

Create `server/utils/plaid-accounts.ts`:
- Import db, schema tables, encrypt/decrypt, eq/and from drizzle-orm
- `createPlaidItem(data: { userId, itemId, encryptedAccessToken, institutionId, institutionName })` — inserts into plaidItems, returns the row
- `getUserPlaidItems(userId: number)` — returns all plaid_items for user (without decrypted token)
- `getPlaidItemAccessToken(itemId: string, userId: number)` — fetches encrypted token, decrypts it, returns plaintext access_token. Throws if not found.
- `getUserPlaidAccounts(userId: number)` — returns all plaid_accounts for user, joined with plaidItems for institution info
- `storePlaidAccounts(userId: number, plaidItemDbId: number, accounts: PlaidAccountBase[])` — upserts accounts from Plaid API response into plaid_accounts table. Use Plaid's AccountBase type for the accounts parameter (import from 'plaid'). Map Plaid fields to DB columns: account_id, name, official_name, mask, type, subtype, balances.current, balances.available, balances.iso_currency_code.

Follow existing patterns from server/utils/transactions.ts: use db.insert/select/delete with returning(), use and(eq()) for ownership checks.
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors across all three files. Verify exports are auto-imported by Nitro (server utils are auto-imported in Nuxt).
  </verify>
  <done>Three server utility files exist and compile cleanly. encrypt/decrypt are symmetric (encrypt then decrypt returns original). plaidClient is a configured PlaidApi instance. CRUD functions for plaid_items and plaid_accounts follow existing project patterns.</done>
</task>

</tasks>

<verification>
- `bun run build` passes with no TypeScript errors
- Database has plaid_items, plaid_accounts, sync_cursors tables
- .env.example documents all four new Plaid env vars
</verification>

<success_criteria>
All Plaid database tables exist and are queryable via Drizzle. Encryption utilities can round-trip a test string. Plaid SDK client is configured. CRUD operations for plaid items and accounts are ready for API endpoints in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/01-plaid-foundation/01-01-SUMMARY.md`
</output>
