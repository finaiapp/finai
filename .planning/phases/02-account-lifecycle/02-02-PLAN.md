---
phase: 02-account-lifecycle
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - server/api/plaid/items/[itemId]/status.get.ts
  - server/api/plaid/items/[itemId]/status.patch.ts
  - server/api/plaid/link-token.post.ts
  - server/utils/plaid-accounts.ts
  - app/composables/usePlaidLink.ts
  - app/components/plaid/ReauthBanner.vue
  - app/components/plaid/AccountsList.vue
autonomous: false

must_haves:
  truths:
    - "GET /api/plaid/items/:itemId/status checks item health at Plaid and updates local status"
    - "PATCH /api/plaid/items/:itemId/status updates local status to healthy after successful re-auth"
    - "Link token endpoint accepts optional item_id body param to create update mode tokens (access_token instead of products)"
    - "usePlaidLink composable exposes openUpdateLink(itemId) that opens Link in update mode without token exchange"
    - "Degraded items show a warning banner with a Re-authenticate button in the accounts list"
    - "Item status is checked when accounts page loads (lazy polling)"
  artifacts:
    - path: "server/api/plaid/items/[itemId]/status.get.ts"
      provides: "GET endpoint to check item health via plaidClient.itemGet()"
      contains: "itemGet"
    - path: "server/api/plaid/items/[itemId]/status.patch.ts"
      provides: "PATCH endpoint to update local item status"
      contains: "updatePlaidItemStatus"
    - path: "server/api/plaid/link-token.post.ts"
      provides: "Modified link token endpoint supporting update mode via item_id param"
      contains: "access_token"
    - path: "app/composables/usePlaidLink.ts"
      provides: "Extended composable with openUpdateLink for re-auth flow"
      contains: "openUpdateLink"
    - path: "app/components/plaid/ReauthBanner.vue"
      provides: "UAlert warning banner with re-authenticate button"
      contains: "UAlert"
    - path: "app/components/plaid/AccountsList.vue"
      provides: "Updated list showing degraded banners and checking status on load"
      contains: "ReauthBanner"
  key_links:
    - from: "server/api/plaid/link-token.post.ts"
      to: "server/utils/plaid-accounts.ts"
      via: "getPlaidItemAccessToken for update mode"
      pattern: "getPlaidItemAccessToken"
    - from: "app/composables/usePlaidLink.ts"
      to: "server/api/plaid/link-token.post.ts"
      via: "$fetch POST with item_id body"
      pattern: "item_id"
    - from: "app/composables/usePlaidLink.ts"
      to: "server/api/plaid/items/[itemId]/status.patch.ts"
      via: "$fetch PATCH to mark healthy after re-auth"
      pattern: "status.*healthy"
    - from: "app/components/plaid/AccountsList.vue"
      to: "app/components/plaid/ReauthBanner.vue"
      via: "component usage per degraded institution"
      pattern: "PlaidReauthBanner|ReauthBanner"
---

<objective>
Connection health monitoring and re-authentication via Plaid Link update mode.

Purpose: Detect when a bank connection degrades (login required, token expired) and allow the user to re-authenticate without losing existing data. This uses Plaid Link's update mode which keeps the existing access token valid.
Output: Status check and update API endpoints, modified link token endpoint for update mode, extended composable with openUpdateLink, a re-auth banner component, and updated accounts list that checks status on load and shows degraded banners.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-account-lifecycle/02-RESEARCH.md
@.planning/phases/02-account-lifecycle/02-01-PLAN.md
@server/utils/plaid-accounts.ts
@server/utils/plaid.ts
@server/api/plaid/link-token.post.ts
@app/composables/usePlaidLink.ts
@app/components/plaid/AccountsList.vue
@app/pages/dashboard/accounts.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server utilities and API endpoints for item status</name>
  <files>server/utils/plaid-accounts.ts, server/api/plaid/items/[itemId]/status.get.ts, server/api/plaid/items/[itemId]/status.patch.ts</files>
  <action>
Add to `server/utils/plaid-accounts.ts`:

1. `updatePlaidItemStatus(itemId: string, userId: number, status: string): Promise<boolean>` -- updates the status field on a plaid_items row. Uses `db.update(plaidItems).set({ status }).where(and(eq(plaidItems.itemId, itemId), eq(plaidItems.userId, userId))).returning({ id: plaidItems.id })`. Returns true if a row was updated.

Create `server/api/plaid/items/[itemId]/status.get.ts`:
- `requireUserSession(event)` for auth
- `checkRateLimit(apiRateLimiter, ...)` for rate limiting
- Get `itemId` from `getRouterParam(event, 'itemId')`
- Validate itemId is non-empty string
- Call `getPlaidItemAccessToken(itemId, session.user.id)` to get decrypted access token (verifies ownership)
- Call `plaidClient.itemGet({ access_token: accessToken })`
- Determine status: if `response.data.item.error` is not null, status is `'degraded'`, otherwise `'healthy'`
- Call `updatePlaidItemStatus(itemId, session.user.id, newStatus)` to persist
- Return `{ status: newStatus, error: item.error ? { error_code: item.error.error_code, display_message: item.error.display_message } : null }`
- Wrap in try/catch: extract Plaid errors with `extractPlaidError(error)`, throw `createError()`

Create `server/api/plaid/items/[itemId]/status.patch.ts`:
- `requireUserSession(event)` for auth
- `checkRateLimit(apiRateLimiter, ...)` for rate limiting
- Get `itemId` from `getRouterParam(event, 'itemId')`
- Read body: `{ status: string }` -- validate status is either 'healthy' or 'degraded', throw 400 otherwise
- Call `updatePlaidItemStatus(itemId, session.user.id, body.status)`
- If no row updated (returns false), throw 404
- Return `{ success: true, status: body.status }`
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. Verify correct Nitro file routing: GET /api/plaid/items/:itemId/status and PATCH /api/plaid/items/:itemId/status.
  </verify>
  <done>Status GET endpoint checks item health at Plaid and updates local DB. Status PATCH endpoint allows setting status after re-auth. updatePlaidItemStatus utility added to plaid-accounts.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Modify link token endpoint for update mode</name>
  <files>server/api/plaid/link-token.post.ts</files>
  <action>
Modify `server/api/plaid/link-token.post.ts` to support Plaid Link update mode:

1. Read optional body: `const body = await readBody<{ item_id?: string }>(event).catch(() => ({}))` -- the body may be empty for normal link mode, so catch parse errors and default to empty object.

2. Build the link config conditionally:
   - If `body.item_id` is provided (truthy string):
     - Call `getPlaidItemAccessToken(body.item_id, session.user.id)` to get decrypted access token (also verifies ownership)
     - Set `access_token` on the config instead of `products`
     - Do NOT include `products` array (Plaid requires omitting products in update mode)
   - Otherwise (normal mode):
     - Include `products: [Products.Transactions]` as before

3. The rest of the endpoint stays the same: call `plaidClient.linkTokenCreate(config)`, return `{ link_token }`.

The key change is that the linkTokenCreate config object either has `products` OR `access_token`, never both.
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. Verify endpoint still works for normal mode (no body) and accepts item_id for update mode.
  </verify>
  <done>Link token endpoint supports update mode via optional item_id body parameter. When item_id is provided, creates a link token with access_token (update mode) instead of products (normal mode).</done>
</task>

<task type="auto">
  <name>Task 3: Extend usePlaidLink composable with openUpdateLink</name>
  <files>app/composables/usePlaidLink.ts</files>
  <action>
Extend the `usePlaidLink` composable to support Plaid Link update mode:

1. Add a new `openUpdateLink(itemId: string)` function:
   - Set `loading.value = true`, `error.value = null`, `success.value = false`
   - Fetch link token with item_id: `$fetch('/api/plaid/link-token', { method: 'POST', body: { item_id: itemId } })`
   - Await `$plaidLinkReady`, check `window.Plaid` exists
   - Create Plaid Link handler with the token, but with a DIFFERENT onSuccess:
     - **Do NOT call /api/plaid/exchange** -- update mode does not return a public_token to exchange
     - Instead, call `$fetch(`/api/plaid/items/${itemId}/status`, { method: 'PATCH', body: { status: 'healthy' } })` to mark the item as healthy
     - Set `success.value = true`
     - Call `onSuccessCallback()` if provided
   - onExit: same pattern as openLink -- set error if err exists, set loading to false
   - Open the handler

2. Return `openUpdateLink` alongside the existing exports: `{ openLink, openUpdateLink, loading, error, success }`

3. Clean up: the existing `onUnmounted` handler cleanup works for both flows since it destroys whatever handler is active.

Key difference from openLink: openUpdateLink does NOT exchange tokens. It only updates the local status to 'healthy' on success.
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. Verify the composable exports openUpdateLink.
  </verify>
  <done>usePlaidLink composable exports openUpdateLink(itemId) that opens Plaid Link in update mode. On success, it marks the item as healthy via PATCH status endpoint. No token exchange occurs.</done>
</task>

<task type="auto">
  <name>Task 4: ReauthBanner component and AccountsList integration</name>
  <files>app/components/plaid/ReauthBanner.vue, app/components/plaid/AccountsList.vue</files>
  <action>
Create `app/components/plaid/ReauthBanner.vue`:
- Props: `institutionName: string`, `loading: boolean` (re-auth in progress)
- Emits: `reauth` (user clicked Re-authenticate)
- Template: UAlert with:
  - `color="warning"`
  - `icon="i-lucide-alert-triangle"`
  - `title="Connection needs attention"`
  - `description` slot or prop: "{institutionName} requires re-authentication. Your accounts are safe but data may be stale."
  - `#actions` slot: UButton with label "Re-authenticate", `@click="emit('reauth')"`, `:loading="loading"`

Update `app/components/plaid/AccountsList.vue`:

1. Add item status tracking:
   - Update `PlaidAccount` interface to include `status: string` (the item status)
   - Update `InstitutionGroup` interface to include `status: string`
   - In `groupedAccounts` computed, set group status from the first account's status field

2. Update `getUserPlaidAccounts()` in `server/utils/plaid-accounts.ts` to also select `plaidItems.status` so the client has access to the item status.

3. Add status checking on mount:
   - After `fetchAccounts()` completes, call a `checkItemStatuses()` function
   - `checkItemStatuses()` iterates over unique item IDs from the accounts, calls `GET /api/plaid/items/${itemId}/status` for each
   - After all status checks complete, re-fetch accounts to get updated statuses
   - Use `Promise.allSettled()` so one failed check does not block others
   - Add a `checkingStatus: ref<boolean>(false)` to show a subtle indicator during checks

4. Add `PlaidReauthBanner` to the template:
   - Inside each institution group's UCard, above the accounts list, show `PlaidReauthBanner` if `group.status === 'degraded'`
   - Wire `@reauth` to call `handleReauth(group.itemId)`

5. Add re-auth handling:
   - Use `usePlaidLink()` composable in AccountsList (import `openUpdateLink`)
   - `handleReauth(itemId: string)`: call `openUpdateLink(itemId)` with a success callback that refreshes the accounts list
   - Track `reauthItemId: ref<string | null>(null)` to show loading state on the correct banner

6. Expose `refresh()` via defineExpose as before (already exists).
  </action>
  <verify>
Run `bun run build` to confirm no TypeScript errors. Verify:
- ReauthBanner component renders with institution name and re-auth button
- AccountsList shows ReauthBanner for degraded institutions
- Status is checked on page load
- Re-auth flow opens Plaid Link update mode and refreshes on success
  </verify>
  <done>ReauthBanner component displays warning for degraded connections. AccountsList checks item statuses on load, shows banners for degraded items, and handles re-authentication via Plaid Link update mode. After successful re-auth, items return to healthy status and the list refreshes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 5: Verify disconnect and re-auth flows end-to-end</name>
  <action>Human verifies the complete Phase 2 flows work in Sandbox mode.</action>
  <what-built>Account disconnect flow (confirmation modal, Plaid API revocation, cascade delete) and connection health monitoring with re-authentication (status check, degraded banner, Plaid Link update mode)</what-built>
  <how-to-verify>
**Disconnect Flow:**
1. Start dev server: `bun run dev`
2. Log in and navigate to /dashboard/accounts
3. Ensure at least one bank is connected (connect one if needed using Sandbox credentials user_good/pass_good)
4. Click "Disconnect" on an institution -- verify confirmation modal appears with institution name
5. Click "Cancel" -- verify modal closes, nothing changes
6. Click "Disconnect" again, then click "Disconnect" in the modal
7. Verify the institution and its accounts disappear from the list
8. Check database: `SELECT * FROM plaid_items` -- verify the row is gone
9. Check database: `SELECT * FROM plaid_accounts` -- verify associated accounts are gone (cascade delete)

**Re-auth Flow (requires Sandbox trick):**
10. Connect a new bank account (Sandbox: user_good/pass_good)
11. Force a degraded state using Plaid Sandbox: run this in a Node/Bun script or via API tool:
    ```
    POST https://sandbox.plaid.com/sandbox/item/reset_login
    { "access_token": "<decrypted token from DB>", "client_id": "<your client id>", "secret": "<your secret>" }
    ```
    Or add a temporary dev endpoint that calls `plaidClient.sandboxItemResetLogin()`
12. Refresh the accounts page -- status check should detect the degraded item
13. Verify a warning banner appears for the degraded institution with "Re-authenticate" button
14. Click "Re-authenticate" -- Plaid Link should open in update mode
15. Complete re-auth with Sandbox credentials (user_good/pass_good)
16. Verify the banner disappears and the item shows as healthy
17. Verify existing accounts are still present (no data loss)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `bun run build` passes with no TypeScript errors
- DELETE /api/plaid/items/:itemId endpoint revokes token and cascade-deletes
- GET /api/plaid/items/:itemId/status checks health at Plaid
- PATCH /api/plaid/items/:itemId/status updates local status
- Link token endpoint supports update mode via item_id parameter
- usePlaidLink exposes openUpdateLink that skips token exchange
- Degraded items show warning banner with re-auth button
- Re-auth restores item to healthy without data loss
</verification>

<success_criteria>
Phase 2 success criteria #2 and #3 are met:
2. When a bank connection degrades, the user sees a clear banner indicating re-auth is needed
3. User can re-authenticate a degraded connection via Plaid Link update mode without losing existing data
Combined with Plan 02-01 (disconnect), all three Phase 2 success criteria are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/02-account-lifecycle/02-02-SUMMARY.md`
</output>
