# Codebase Structure

**Analysis Date:** 2025-02-15

## Directory Layout

```
finai/
├── app/                        # Nuxt 4 client source (auto-imports enabled)
│   ├── app.vue                 # Root component with NuxtLayout + NuxtPage
│   ├── pages/                  # File-based routing
│   │   ├── index.vue           # Landing page (/)
│   │   ├── login.vue           # (/login)
│   │   ├── register.vue        # (/register)
│   │   ├── forgot-password.vue # (/forgot-password)
│   │   ├── reset-password.vue  # (/reset-password)
│   │   ├── verify-email.vue    # (/verify-email) - no middleware
│   │   └── dashboard/          # /dashboard/* routes (all use auth middleware + dashboard layout)
│   │       ├── index.vue       # Overview cards + recent transactions
│   │       ├── transactions.vue # Full transaction list/CRUD
│   │       ├── budgets.vue     # Budget management (stub)
│   │       └── settings.vue    # User profile display
│   ├── components/             # Auto-imported Vue components (by folder prefix)
│   │   ├── auth/
│   │   │   ├── OAuthButtons.vue
│   │   │   ├── LoginForm.vue
│   │   │   ├── RegisterForm.vue
│   │   │   ├── ForgotPasswordForm.vue
│   │   │   └── ResetPasswordForm.vue
│   │   ├── dashboard/
│   │   │   ├── Sidebar.vue
│   │   │   └── OverviewCard.vue
│   │   ├── landing/
│   │   │   ├── Hero.vue
│   │   │   ├── Features.vue
│   │   │   └── CallToAction.vue
│   │   └── transactions/
│   │       ├── TransactionForm.vue
│   │       ├── TransactionList.vue
│   │       ├── TransactionFilters.vue
│   │       └── TransactionDeleteConfirm.vue
│   ├── composables/            # Auto-imported composables
│   │   ├── useAuth.ts          # login(), register(), logout()
│   │   ├── useTransactions.ts  # fetchTransactions(), addTransaction(), editTransaction(), removeTransaction()
│   │   ├── useCategories.ts    # fetchCategories(), addCategory(), editCategory(), removeCategory()
│   │   └── useDashboardSummary.ts # fetchSummary() - returns totalBalance, monthlySpending, recentTransactionCount
│   ├── layouts/
│   │   ├── default.vue         # Header (logo, nav) + footer (GitHub link)
│   │   └── dashboard.vue       # UDashboardGroup with sidebar + panel
│   ├── middleware/
│   │   ├── auth.ts             # Requires session, redirects to /login or /verify-email
│   │   └── guest.ts            # Redirects logged-in users to /dashboard
│   ├── utils/
│   │   ├── error.ts            # extractErrorMessage()
│   │   ├── handle-api-error.ts # handleApiError() - 401 redirect + auto-logout
│   │   ├── validation.ts       # validateTransactionForm(), validateNotes()
│   │   └── format.ts           # formatAmount() (Intl.NumberFormat USD), formatDate() (UTC-safe)
│   ├── plugins/
│   │   └── (auth plugin auto-setup via nuxt-auth-utils)
│   └── assets/css/
│       └── (global styles, Tailwind customizations)
│
├── server/                      # Nitro backend
│   ├── api/                     # API routes (POST /api/auth/login → login.post.ts)
│   │   ├── auth/
│   │   │   ├── login.post.ts
│   │   │   ├── register.post.ts
│   │   │   ├── logout.post.ts
│   │   │   ├── verify-email.post.ts
│   │   │   ├── resend-verification.post.ts
│   │   │   ├── forgot-password.post.ts
│   │   │   └── reset-password.post.ts
│   │   ├── transactions/
│   │   │   ├── index.get.ts    # GET /api/transactions (query params: type, categoryId, startDate, endDate, limit, offset)
│   │   │   ├── index.post.ts   # POST /api/transactions
│   │   │   ├── [id].get.ts     # GET /api/transactions/:id
│   │   │   ├── [id].put.ts     # PUT /api/transactions/:id
│   │   │   └── [id].delete.ts  # DELETE /api/transactions/:id
│   │   ├── categories/
│   │   │   ├── index.get.ts    # GET /api/categories (returns user's categories + auto-seeded defaults)
│   │   │   ├── index.post.ts   # POST /api/categories
│   │   │   ├── [id].put.ts     # PUT /api/categories/:id
│   │   │   └── [id].delete.ts  # DELETE /api/categories/:id
│   │   └── dashboard/
│   │       └── summary.get.ts  # GET /api/dashboard/summary (totalBalance, monthlySpending, recentTransactionCount)
│   ├── routes/                  # Non-API routes (OAuth handlers)
│   │   └── auth/
│   │       ├── github.get.ts    # OAuth callback handler
│   │       └── google.get.ts    # OAuth callback handler
│   ├── database/
│   │   ├── index.ts            # Drizzle ORM instance export
│   │   ├── schema.ts           # Table definitions (users, verificationTokens, categories, transactions)
│   │   └── migrations/         # SQL migrations (auto-generated by Drizzle Kit)
│   ├── utils/
│   │   ├── auth.ts             # findUserByEmail(), createUser(), verifyToken(), createVerificationToken()
│   │   ├── transactions.ts     # getUserTransactions(), createTransaction(), editTransaction(), deleteTransaction(), getDashboardSummary()
│   │   ├── categories.ts       # getCategoryList(), createCategory(), editCategory(), deleteCategory(), seedDefaultCategories()
│   │   ├── validation.ts       # validateEmail(), validatePassword(), validateCategoryName(), validateTransaction()
│   │   ├── rate-limit.ts       # authRateLimiter, accountRateLimiter, verificationRateLimiter, apiRateLimiter + checkRateLimit()
│   │   └── email.ts            # sendVerificationEmail(), sendPasswordResetEmail() via Resend
│   └── middleware/
│       └── (logging, CORS, security headers - auto-setup via nuxt.config)
│
├── tests/                       # Playwright E2E tests
│   ├── auth/
│   │   ├── pages.spec.ts
│   │   ├── api-flows.spec.ts
│   │   └── route-protection.spec.ts
│   ├── landing/
│   │   └── landing.spec.ts
│   ├── security/
│   │   ├── headers.spec.ts
│   │   ├── rate-limiting.spec.ts
│   │   └── enumeration.spec.ts
│   └── transactions/
│       ├── api.spec.ts
│       └── pages.spec.ts
│
├── nuxt.config.ts              # Nuxt config (modules, devServer port 3889, vite HMR, runtimeConfig)
├── package.json                # Dependencies (bun)
├── .env (not committed)        # DATABASE_URL, SESSION_PASSWORD, OAuth credentials
└── public/                     # Static assets
```

## Directory Purposes

**app/pages/:**
- Purpose: Page components that automatically map to routes via file structure
- Naming convention: filename = route path (index.vue = /, login.vue = /login, dashboard/transactions.vue = /dashboard/transactions)
- Each page can have `definePageMeta()` to set layout and middleware
- Unauthenticated pages: index.vue, login.vue, register.vue, forgot-password.vue, reset-password.vue, verify-email.vue
- Authenticated pages: All under dashboard/ with `middleware: 'auth'` and `layout: 'dashboard'`

**app/components/:**
- Purpose: Reusable Vue components auto-imported by Nuxt (name = folder prefix + filename)
- Examples: `components/auth/LoginForm.vue` → `<AuthLoginForm />`
- Organized by feature area: auth (forms), dashboard (layout components), landing (marketing sections), transactions (CRUD UI)

**app/composables/:**
- Purpose: Auto-imported Vue 3 composables that wrap API calls and provide typed state
- Pattern: Return reactive refs + async functions, expose `error` ref for UI error handling
- Used in: Page components and form components via `const { data, loading, error, fetchData } = useFeature()`

**app/layouts/:**
- Purpose: Shared page layout wrappers
- `default.vue`: Header with navigation + footer (used by public pages and landing)
- `dashboard.vue`: UDashboardGroup wrapper with Sidebar + Panel (used by authenticated pages)

**app/middleware/:**
- Purpose: Route guards that run before page loads
- `auth.ts`: Requires session; redirects to /login if missing; redirects to /verify-email if email not verified
- `guest.ts`: Redirects already-logged-in users to /dashboard

**app/utils/:**
- Purpose: Client-side utility functions (not auto-imported; must be explicitly imported)
- `error.ts`: Extract error messages from API response objects
- `handle-api-error.ts`: Wrapper that checks for 401 and auto-redirects to login
- `validation.ts`: Duplicate server validation rules for client-side form validation
- `format.ts`: Format amounts and dates for display

**server/api/:**
- Purpose: REST API endpoints auto-mapped from file structure (POST /api/auth/login ← server/api/auth/login.post.ts)
- Convention: `[method].[ts]` where method = get, post, put, delete, patch
- Dynamic params: `[id].ts` → `/api/resource/:id`
- Every endpoint checks session via `requireUserSession()` and rate limits via `checkRateLimit()`

**server/routes/:**
- Purpose: Non-API routes, typically for OAuth callbacks
- Convention: `/auth/github` → `server/routes/auth/github.get.ts`
- Used for: OAuth callback handling, redirects (not JSON response APIs)

**server/database/:**
- Purpose: Database schema and ORM configuration
- `schema.ts`: Drizzle ORM table definitions with indices and relations
- `index.ts`: Drizzle ORM instance creation with postgres.js driver
- `migrations/`: Auto-generated SQL migration files from schema changes

**server/utils/:**
- Purpose: Reusable business logic functions (database queries, validation, external services)
- `auth.ts`: User lookup, creation, password hashing, token verification
- `transactions.ts`: CRUD operations, dashboard summary aggregation
- `categories.ts`: Category CRUD, default category seeding
- `validation.ts`: Input validation rules (mirrors client validation)
- `rate-limit.ts`: Rate limiter instances and enforcement function
- `email.ts`: Email sending via Resend API

**tests/:**
- Purpose: End-to-end tests via Playwright
- Structure: Mirrors app structure (auth/, landing/, security/, transactions/)
- Pattern: `*.spec.ts` files use `@nuxt/test-utils/playwright` (not bare `@playwright/test`)

## Key File Locations

**Entry Points:**
- `app/app.vue`: Root component (NuxtLayout + NuxtPage)
- `app/pages/index.vue`: Landing page
- `app/pages/dashboard/index.vue`: Dashboard overview (protected)
- `server/api/auth/login.post.ts`: Authentication API entry

**Configuration:**
- `nuxt.config.ts`: Nuxt configuration (modules, dev server, vite HMR, session config)
- `tsconfig.json`: TypeScript configuration
- `package.json`: Dependencies and scripts (bun run dev, bun run build, etc.)
- `.env`: Environment variables (DATABASE_URL, SESSION_PASSWORD, OAuth credentials) — NOT committed

**Core Logic:**
- `server/database/schema.ts`: Table definitions (users, verificationTokens, categories, transactions)
- `server/utils/auth.ts`: User and token queries/creation
- `server/utils/transactions.ts`: Transaction CRUD and summary aggregation
- `app/composables/useAuth.ts`: Client auth wrapper (login, register, logout)
- `app/composables/useTransactions.ts`: Client transaction CRUD wrapper

**Testing:**
- `tests/auth/api-flows.spec.ts`: Auth endpoint integration tests
- `tests/transactions/api.spec.ts`: Transaction endpoint authorization tests
- `tests/security/rate-limiting.spec.ts`: Rate limit enforcement tests

## Naming Conventions

**Files:**
- Pages: Lowercase with hyphens (`login.vue`, `forgot-password.vue`), match route path
- Components: PascalCase (`LoginForm.vue`, `TransactionList.vue`), imported with prefix (`<AuthLoginForm />`)
- Composables: camelCase starting with `use` (`useAuth.ts`, `useTransactions.ts`)
- Utilities: camelCase (`error.ts`, `handle-api-error.ts`)
- API routes: Lowercase with method suffix (`login.post.ts`, `index.get.ts`)
- Database schema: Lowercase table names (`users`, `transactions`, `categories`)

**Directories:**
- Feature-based grouping: `components/auth/`, `components/dashboard/`, `components/landing/`, `components/transactions/`
- Logical layers: `api/`, `routes/`, `utils/`, `middleware/`, `database/`
- Test mirrors source: `tests/auth/`, `tests/transactions/`, `tests/security/`

**Variables & Functions:**
- Composables: `const { loggedIn, user, login } = useAuth()`
- API responses: `{ user, message, items, total }` — consistent property names
- States: `loading`, `error`, `data` pattern
- Event handlers: `on` + action (onSuccess, onError, onSubmit)

## Where to Add New Code

**New Feature (Full CRUD):**
- API endpoints: `server/api/features/index.get.ts`, `index.post.ts`, `[id].put.ts`, `[id].delete.ts`
- Database table: Add to `server/database/schema.ts`
- Server utility: Create `server/utils/features.ts` with query functions
- Client composable: Create `app/composables/useFeatures.ts` with error handling
- Page: Create `app/pages/dashboard/features.vue` with `middleware: 'auth'`
- Components: Add to `app/components/features/` (FeatureForm.vue, FeatureList.vue, etc.)
- Tests: Create `tests/features/api.spec.ts` and `tests/features/pages.spec.ts`

**New Component:**
- Location: `app/components/[feature]/ComponentName.vue`
- Auto-imported as `<FeatureComponentName />`
- Use Nuxt UI components (UButton, UInput, USelect, etc.)
- Props should be typed with `defineProps<{ ... }>()`
- Emits should use `defineEmits<{ ... }>()`

**New Utility Function:**
- Shared client utility: `app/utils/function-name.ts`
- Shared server utility: `server/utils/function-name.ts`
- Validation rules: Add to `server/utils/validation.ts` and mirror in `app/utils/validation.ts`

**New Page:**
- Location: `app/pages/[route-path]/page-name.vue`
- If protected: Add `definePageMeta({ middleware: 'auth' })`
- If uses dashboard layout: Add `definePageMeta({ layout: 'dashboard' })`
- Use composables for data fetching in `onMounted()` or within component logic

**API Endpoint:**
- Location: `server/api/[resource]/[method-suffix].ts`
- Always check rate limit first: `await checkRateLimit(apiRateLimiter, getRequestIP(...))`
- Require session: `const session = await requireUserSession(event)`
- Validate input: Use functions from `server/utils/validation.ts`
- Call utility function: Import from `server/utils/[resource].ts`
- Return typed response or throw `createError()`

## Special Directories

**node_modules/:**
- Purpose: Installed dependencies (bun package manager)
- Generated: Yes
- Committed: No (git ignored)

**.nuxt/:**
- Purpose: Nuxt build cache and generated types
- Generated: Yes
- Committed: No (git ignored)

**.output/:**
- Purpose: Production build output
- Generated: Yes (via `bun run build`)
- Committed: No (git ignored)

**public/:**
- Purpose: Static assets served at root (images, favicons, etc.)
- Generated: No
- Committed: Yes

**tests/:**
- Purpose: E2E test files (Playwright)
- Pattern: `*.spec.ts` files auto-discovered
- Run: `bun run test:e2e` or `bunx playwright test tests/file.spec.ts`

**server/database/migrations/:**
- Purpose: SQL migration files (auto-generated by Drizzle Kit)
- Generated: Yes (via `bun run db:generate`)
- Committed: Yes
- Applied: Automatically on server startup

---

*Structure analysis: 2025-02-15*
